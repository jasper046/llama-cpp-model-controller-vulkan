<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Llama Model Controller</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen p-4">
    <div class="container mx-auto">
        <h1 class="text-3xl font-bold mb-6 text-center">Llama Model Controller</h1>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <!-- Left Column: All Controls (1/3 width) -->
            <div class="md:col-span-1 space-y-4">
                <!-- Model Selection -->
                <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                    <h2 class="text-xl font-bold mb-4">Model Selection</h2>
                    <p id="status" class="mb-2 text-sm">Checking status...</p>
                    <p id="message" class="mb-4 text-yellow-400 text-sm"></p>

                    <form id="modelForm">
                        <label class="block text-left mb-1">Select Model</label>
                        <select id="model" name="model" class="w-full bg-gray-700 text-white p-2 rounded mb-3">
                            {% for model in models %}
                            <option value="{{ model }}">{{ model }}</option>
                            {% endfor %}
                        </select>

                        <div class="flex justify-between space-x-2 mb-2">
                            <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded flex-1">
                                Start Model
                            </button>
                            <button id="stop" type="button" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded flex-1">
                                Stop Model
                            </button>
                        </div>
                        <button id="reset-defaults" type="button" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded mb-2">
                            Reset to Defaults
                        </button>
                    </form>
                </div>

                <!-- Model Parameters -->
                <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                    <h2 class="text-xl font-bold mb-4">Model Parameters</h2>

                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-left mb-1">GPU Layers</label>
                            <input type="number" id="ngl" name="ngl" form="modelForm" value="99" class="w-full bg-gray-700 text-white p-2 rounded mb-3">
                        </div>
                        <div>
                            <label class="block text-left mb-1">Context Size</label>
                            <input type="number" id="ctx_size" name="ctx_size" form="modelForm" value="16384" class="w-full bg-gray-700 text-white p-2 rounded mb-3">
                        </div>
                        <div>
                            <label class="block text-left mb-1">Port</label>
                            <input type="number" id="port" name="port" form="modelForm" value="4000" class="w-full bg-gray-700 text-white p-2 rounded mb-3">
                        </div>
                        <div>
                            <label class="block text-left mb-1">Host</label>
                            <input type="text" id="host" name="host" form="modelForm" value="0.0.0.0" class="w-full bg-gray-700 text-white p-2 rounded mb-3">
                        </div>
                    </div>
                </div>

                <!-- Advanced Settings -->
                <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                    <h2 class="text-xl font-bold mb-4">Advanced Settings</h2>

                    <div>
                        <label class="block text-left mb-1">Main GPU</label>
                        <select id="main_gpu" name="main_gpu" form="modelForm" class="w-full bg-gray-700 text-white p-2 rounded mb-3">
                            {% for gpu in gpus %}
                            <option value="{{ gpu.vulkan_id }}">GPU {{ gpu.vulkan_id }} ({{ gpu.display_name }})</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div>
                        <label class="block text-left mb-1">{{ tensor_split_label }}</label>
                        <input type="text" id="tensor_split" name="tensor_split" form="modelForm" value="1,0.4" placeholder="1,0.4" class="w-full bg-gray-700 text-white p-2 rounded mb-3">
                    </div>

                    <div>
                        <label class="block text-left mb-1">Batch Size</label>
                        <input type="number" id="batch_size" name="batch_size" form="modelForm" value="512" class="w-full bg-gray-700 text-white p-2 rounded mb-3">
                    </div>

                    <div>
                        <label class="block text-left mb-1">UBatch Size</label>
                        <input type="number" id="ubatch_size" name="ubatch_size" form="modelForm" value="128" class="w-full bg-gray-700 text-white p-2 rounded mb-3">
                    </div>

                    <div>
                        <label class="block text-left mb-1">Flash Attention</label>
                        <select id="flash_attn" name="flash_attn" form="modelForm" class="w-full bg-gray-700 text-white p-2 rounded mb-3">
                            <option value="on">On</option>
                            <option value="off">Off</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-left mb-1">Parallel Sequences</label>
                        <input type="number" id="parallel" name="parallel" form="modelForm" value="1" class="w-full bg-gray-700 text-white p-2 rounded mb-3">
                    </div>

                    <div>
                        <label class="block text-left mb-1">Continuous Batching</label>
                        <select id="cont_batching" name="cont_batching" form="modelForm" class="w-full bg-gray-700 text-white p-2 rounded mb-3">
                            <option value="true">Enabled</option>
                            <option value="false">Disabled</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Right Column: GPU Stats & Server Logs (2/3 width) -->
            <div class="md:col-span-2 space-y-4">
                <!-- GPU Stats -->
                <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                    <h2 class="text-xl font-bold mb-2">GPU Usage (AMD Radeon)</h2>
                    <div id="gpu-stats" class="text-sm space-y-4">
                        Loading...
                    </div>
                </div>

                <!-- Server Logs -->
                <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="text-xl font-bold">Server Logs</h2>
                        <div>
                            <button id="clear-logs" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-sm">
                                Clear
                            </button>
                            <button id="auto-scroll" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm ml-2" data-enabled="true">
                                Auto-scroll: ON
                            </button>
                        </div>
                    </div>
                    <div id="server-logs-container" class="bg-gray-900 rounded p-3 h-64 overflow-y-auto font-mono text-sm">
                        <pre id="server-logs" class="whitespace-pre-wrap"></pre>
                    </div>
                    <div class="flex mt-2 text-xs">
                        <span class="inline-block w-3 h-3 bg-red-500 rounded-full mr-1"></span>
                        <span class="mr-3">Error</span>
                        <span class="inline-block w-3 h-3 bg-yellow-500 rounded-full mr-1"></span>
                        <span class="mr-3">Warning</span>
                        <span class="inline-block w-3 h-3 bg-green-500 rounded-full mr-1"></span>
                        <span class="mr-3">Token Info</span>
                        <span class="inline-block w-3 h-3 bg-blue-500 rounded-full mr-1"></span>
                        <span>System</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Settings persistence
        const STORAGE_KEY = 'llama_model_controller_settings';

        function saveSettingsToLocalStorage() {
            const settings = {};

            // Model selection - store index, not value
            const modelSelect = document.getElementById('model');
            if (modelSelect) {
                settings.model_index = modelSelect.selectedIndex;
            }

            // Model parameters
            settings.ngl = document.getElementById('ngl').value;
            settings.ctx_size = document.getElementById('ctx_size').value;
            settings.port = document.getElementById('port').value;
            settings.host = document.getElementById('host').value;

            // Advanced settings
            settings.main_gpu = document.getElementById('main_gpu').value;
            settings.tensor_split = document.getElementById('tensor_split').value;
            settings.batch_size = document.getElementById('batch_size').value;
            settings.ubatch_size = document.getElementById('ubatch_size').value;
            settings.flash_attn = document.getElementById('flash_attn').value;
            settings.parallel = document.getElementById('parallel').value;
            settings.cont_batching = document.getElementById('cont_batching').value;

            localStorage.setItem(STORAGE_KEY, JSON.stringify(settings));
            console.log('Settings saved to localStorage:', settings);
        }

        function loadSettingsFromLocalStorage() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (!saved) return false;

            try {
                const settings = JSON.parse(saved);

                // Model selection - restore by index
                if (settings.model_index !== undefined) {
                    const modelSelect = document.getElementById('model');
                    if (modelSelect && modelSelect.options.length > settings.model_index) {
                        modelSelect.selectedIndex = settings.model_index;
                    }
                }

                // Model parameters
                if (settings.ngl !== undefined) document.getElementById('ngl').value = settings.ngl;
                if (settings.ctx_size !== undefined) document.getElementById('ctx_size').value = settings.ctx_size;
                if (settings.port !== undefined) document.getElementById('port').value = settings.port;
                if (settings.host !== undefined) document.getElementById('host').value = settings.host;

                // Advanced settings
                if (settings.main_gpu !== undefined) document.getElementById('main_gpu').value = settings.main_gpu;
                if (settings.tensor_split !== undefined) document.getElementById('tensor_split').value = settings.tensor_split;
                if (settings.batch_size !== undefined) document.getElementById('batch_size').value = settings.batch_size;
                if (settings.ubatch_size !== undefined) document.getElementById('ubatch_size').value = settings.ubatch_size;
                if (settings.flash_attn !== undefined) document.getElementById('flash_attn').value = settings.flash_attn;
                if (settings.parallel !== undefined) document.getElementById('parallel').value = settings.parallel;
                if (settings.cont_batching !== undefined) document.getElementById('cont_batching').value = settings.cont_batching;

                console.log('Settings loaded from localStorage:', settings);
                return true;
            } catch (e) {
                console.error('Error loading settings from localStorage:', e);
                return false;
            }
        }

        async function saveSettingsToBackend() {
            const settings = {};

            // Collect settings same as localStorage
            const modelSelect = document.getElementById('model');
            if (modelSelect) {
                settings.model_index = modelSelect.selectedIndex;
            }

            settings.ngl = document.getElementById('ngl').value;
            settings.ctx_size = document.getElementById('ctx_size').value;
            settings.port = document.getElementById('port').value;
            settings.host = document.getElementById('host').value;
            settings.main_gpu = document.getElementById('main_gpu').value;
            settings.tensor_split = document.getElementById('tensor_split').value;
            settings.batch_size = document.getElementById('batch_size').value;
            settings.ubatch_size = document.getElementById('ubatch_size').value;
            settings.flash_attn = document.getElementById('flash_attn').value;
            settings.parallel = document.getElementById('parallel').value;
            settings.cont_batching = document.getElementById('cont_batching').value;

            try {
                const response = await fetch('/save_settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(settings)
                });
                const result = await response.json();
                if (result.success) {
                    console.log('Settings saved to backend:', result.status);
                } else {
                    console.error('Failed to save settings to backend:', result.status);
                }
                return result.success;
            } catch (e) {
                console.error('Error saving settings to backend:', e);
                return false;
            }
        }

        async function resetSettings() {
            // Clear localStorage
            localStorage.removeItem(STORAGE_KEY);

            // Reset backend settings
            try {
                const response = await fetch('/reset_settings', { method: 'POST' });
                const result = await response.json();
                if (result.success) {
                    console.log('Backend settings reset:', result.status);
                } else {
                    console.error('Failed to reset backend settings:', result.status);
                }
            } catch (e) {
                console.error('Error resetting backend settings:', e);
            }

            // Reload page to apply defaults
            location.reload();
        }

        // Set up event listeners for auto-saving
        function setupAutoSave() {
            const inputs = [
                'model', 'ngl', 'ctx_size', 'port', 'host',
                'main_gpu', 'tensor_split', 'batch_size', 'ubatch_size',
                'flash_attn', 'parallel', 'cont_batching'
            ];

            inputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', () => {
                        saveSettingsToLocalStorage();
                        // Optionally save to backend on change (uncomment if desired)
                        // saveSettingsToBackend();
                    });
                }
            });
        }

        async function updateStatus() {
            let response = await fetch("/status");
            let data = await response.json();
            document.getElementById("status").innerText = data.running ? "Model is running." : "Model is stopped.";
        }

        async function updateGPUStats() {
            let response = await fetch("/gpu");
            let gpus = await response.json();
            let gpuContainer = document.getElementById("gpu-stats");
            gpuContainer.innerHTML = "";

            if (gpus.length === 0 || gpus[0].error) {
                gpuContainer.innerHTML = `<p class="text-red-400">Error: ${gpus[0]?.error || "No data"}</p>`;
                return;
            }

            gpus.forEach(gpu => {
                // Parse GPU usage percentage
                let gpuUsagePercent = 0;
                let gpuUsageText = gpu.usage;
                if (gpu.usage && gpu.usage !== 'N/A') {
                    const match = gpu.usage.match(/(\d+)%/);
                    if (match) gpuUsagePercent = parseInt(match[1]);
                }

                // Parse memory usage
                let memUsed = 0, memTotal = 0, memPercent = 0;
                let memText = gpu.memory;
                if (gpu.memory && gpu.memory.includes('Gi/')) {
                    const memMatch = gpu.memory.match(/(\d+\.?\d*)Gi\/(\d+\.?\d*)Gi/);
                    if (memMatch) {
                        memUsed = parseFloat(memMatch[1]);
                        memTotal = parseFloat(memMatch[2]);
                        if (memTotal > 0) memPercent = Math.round((memUsed / memTotal) * 100);
                    }
                }

                gpuContainer.innerHTML += `
                    <div class="p-3 bg-gray-700 rounded">
                        <p class="font-bold text-lg">${gpu.name} (card: ${gpu.index}, Vulkan: ${gpu.vulkan_id})</p>

                        <!-- Other Stats Grid -->
                        <div class="grid grid-cols-2 gap-2 mt-3">
                            <div>
                                <p class="text-sm">Temp: <span class="font-semibold">${gpu.temp}</span></p>
                                <p class="text-sm">Power: <span class="font-semibold">${gpu.power}</span></p>
                            </div>
                            <div>
                                <p class="text-sm">Fan Speed: <span class="font-semibold">${gpu.fan_speed || 'N/A'}</span></p>
                                <p class="text-sm">Usage: <span class="font-semibold">${gpu.usage}</span></p>
                            </div>
                        </div>

                        ${gpu.memory ? `
                        <div class="mt-3 pt-3 border-t border-gray-600">
                            <p class="text-sm mb-1">Memory: <span class="font-semibold">${gpu.memory}</span></p>
                            <p class="text-sm mb-2">Mem Clock: <span class="font-semibold">${gpu.mem_clock || 'N/A'}</span></p>
                            ${gpu.memory.includes('Gi/') ? `
                            <div class="flex justify-between text-xs mb-1">
                                <span>VRAM Usage</span>
                                <span>${memPercent}% (${memUsed.toFixed(2)}Gi/${memTotal.toFixed(2)}Gi)</span>
                            </div>
                            <div class="w-full bg-gray-800 rounded-full h-2">
                                <div class="bg-blue-500 h-2 rounded-full" style="width: ${memPercent}%"></div>
                            </div>` : ''}
                        </div>` : ''}

                        <!-- GPU Clock and Usage Bar -->
                        <div class="mt-3 pt-3 border-t border-gray-600">
                            <p class="text-sm mb-1">GPU Clock: <span class="font-semibold">${gpu.gpu_clock || 'N/A'}</span></p>
                            ${gpu.usage && gpu.usage !== 'N/A' ? `
                            <div class="mt-1">
                                <div class="flex justify-between text-xs mb-1">
                                    <span>GPU Usage</span>
                                    <span>${gpuUsagePercent}%</span>
                                </div>
                                <div class="w-full bg-gray-800 rounded-full h-2">
                                    <div class="bg-green-500 h-2 rounded-full" style="width: ${gpuUsagePercent}%"></div>
                                </div>
                            </div>` : ''}
                        </div>
                    </div>
                `;
            });
        }

        async function fetchServerLogs() {
            if (!document.getElementById("server-logs")) {
                return; // Exit if the logs element doesn't exist
            }

            const response = await fetch("/logs");
            if (!response.ok) {
                return;
            }

            const logs = await response.json();
            
            // Get reference to the logs container
            const logsElement = document.getElementById("server-logs");
            
            // Clear old logs if requested
            if (logs.reset) {
                logsElement.innerHTML = "";
            }
            
            // Add new logs with color coding
            if (logs.entries && logs.entries.length > 0) {
                logs.entries.forEach(entry => {
                    // Create a new log line
                    const logLine = document.createElement("div");
                    
                    // Add appropriate color class based on log type
                    if (entry.text.includes("error") || entry.text.includes("ERROR")) {
                        logLine.className = "text-red-400"; // Error
                    } else if (entry.text.includes("warn") || entry.text.includes("WARN")) {
                        logLine.className = "text-yellow-400"; // Warning
                    } else if (entry.text.includes("token") || entry.text.includes("tokens")) {
                        logLine.className = "text-green-400"; // Token info
                    } else {
                        logLine.className = "text-blue-300"; // System info
                    }
                    
                    // Set the text content
                    logLine.textContent = entry.text;
                    
                    // Append to logs container
                    logsElement.appendChild(logLine);
                });
                
                // Auto-scroll if enabled
                const logsContainer = document.getElementById("server-logs-container");
                const autoScrollBtn = document.getElementById("auto-scroll");
                if (autoScrollBtn.getAttribute("data-enabled") === "true") {
                    logsContainer.scrollTop = logsContainer.scrollHeight;
                }
            }
        }

        document.getElementById("modelForm").addEventListener("submit", async (event) => {
            event.preventDefault();
            
            // Use FormData to collect all form elements
            const formData = new FormData(document.getElementById("modelForm"));
            
            // Log what we're sending (for debugging)
            console.log("Sending form data:");
            for (let pair of formData.entries()) {
                console.log(pair[0] + ': ' + pair[1]);
            }

            let response = await fetch("/start", {
                method: "POST",
                body: formData
            });

            let result = await response.json();
            document.getElementById("message").innerText = result.status;
            updateStatus();
            updateGPUStats();  // Refresh GPU stats when model starts
        });

        document.getElementById("stop").addEventListener("click", async () => {
            let response = await fetch("/stop", { method: "POST" });
            let result = await response.json();
            document.getElementById("message").innerText = result.status;
            updateStatus();
        });

        // Add event listeners for the log controls and settings
        document.addEventListener("DOMContentLoaded", function() {
            // Load saved settings
            loadSettingsFromLocalStorage();

            // Setup auto-save on form changes
            setupAutoSave();

            // Reset defaults button
            const resetDefaultsBtn = document.getElementById("reset-defaults");
            if (resetDefaultsBtn) {
                resetDefaultsBtn.addEventListener("click", resetSettings);
            }

            // Log controls
            const clearLogsBtn = document.getElementById("clear-logs");
            const autoScrollBtn = document.getElementById("auto-scroll");

            if (clearLogsBtn) {
                clearLogsBtn.addEventListener("click", () => {
                    document.getElementById("server-logs").innerHTML = "";
                });
            }

            if (autoScrollBtn) {
                autoScrollBtn.addEventListener("click", () => {
                    const currentState = autoScrollBtn.getAttribute("data-enabled") === "true";
                    const newState = !currentState;
                    autoScrollBtn.setAttribute("data-enabled", newState);
                    autoScrollBtn.textContent = `Auto-scroll: ${newState ? "ON" : "OFF"}`;
                    autoScrollBtn.className = newState
                        ? "bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm ml-2"
                        : "bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-sm ml-2";
                });
            }
        });

        updateStatus();
        updateGPUStats();
        setInterval(updateStatus, 5000);
        setInterval(updateGPUStats, 2000);
        setInterval(fetchServerLogs, 1000); // Fetch logs every second
    </script>
</body>
</html>